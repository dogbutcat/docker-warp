#!/command/with-contenv bash
set -euo pipefail

WARP_MDM_ENABLED="${WARP_MDM_ENABLED:-false}"
WARP_MODE="${WARP_MODE:-proxy}"
WARP_SERVICE_MODE="${WARP_SERVICE_MODE:-}"
WARP_PROXY_PORT="${WARP_PROXY_PORT:-40000}"
WARP_LICENSE_KEY="${WARP_LICENSE_KEY:-}"

# 判断是否需要 proxy 端口就绪
is_proxy_mode() {
  [ "$WARP_MODE" = "proxy" ] || [ "$WARP_SERVICE_MODE" = "proxy" ]
}

# connect 后等待 proxy 端口就绪
wait_proxy_ready() {
  if ! is_proxy_mode; then
    return 0
  fi
  echo "Waiting for WARP proxy port ${WARP_PROXY_PORT} to be ready..."
  local n=0
  while true; do
    if (echo > /dev/tcp/127.0.0.1/${WARP_PROXY_PORT}) 2>/dev/null; then
      echo "WARP proxy port ${WARP_PROXY_PORT} is ready"
      return 0
    fi
    n=$((n + 1))
    if [ $((n % 30)) -eq 0 ]; then
      echo "Still waiting for WARP proxy port ${WARP_PROXY_PORT}... (${n}s)"
    fi
    sleep 1
  done
}

# Wait for warp-svc to accept commands.
for i in $(seq 1 60); do
  if warp-cli --accept-tos status >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

if ! warp-cli --accept-tos status >/dev/null 2>&1; then
  echo "warp-cli is not ready"
  exit 1
fi

# MDM 模式：由 mdm.xml 控制注册和配置，等待自动注册完成
if [ "$WARP_MDM_ENABLED" = "true" ]; then
  echo "MDM deployment mode enabled, waiting for service token registration..."
  for i in $(seq 1 90); do
    REG_STATUS=$(warp-cli --accept-tos registration show 2>&1) || true
    if echo "$REG_STATUS" | grep -qi "organization\|account\|team"; then
      echo "MDM registration successful"
      warp-cli --accept-tos connect
      wait_proxy_ready
      exit 0
    fi
    echo "Waiting for MDM registration... (${i}/90)"
    sleep 2
  done
  echo "WARNING: MDM registration not completed after 180s, please check service token config"
  echo "Container will keep running, warp-svc may complete registration later"
  exit 0
fi

# LICENSE_KEY 模式：手动注册
if [ -n "$WARP_LICENSE_KEY" ]; then
  if ! warp-cli --accept-tos registration show >/dev/null 2>&1; then
    warp-cli --accept-tos registration new
  fi
  warp-cli --accept-tos registration license "$WARP_LICENSE_KEY"

  case "$WARP_MODE" in
    proxy)
      warp-cli --accept-tos proxy port "$WARP_PROXY_PORT"
      warp-cli --accept-tos mode proxy
      ;;
    warp|doh|warp+doh|dot|warp+dot|tunnel_only)
      warp-cli --accept-tos mode "$WARP_MODE"
      ;;
    *)
      echo "Unsupported WARP_MODE: $WARP_MODE"
      echo "Valid: warp / doh / warp+doh / dot / warp+dot / proxy / tunnel_only"
      exit 1
      ;;
  esac

  warp-cli --accept-tos connect
  wait_proxy_ready
else
  echo "No WARP_LICENSE_KEY or MDM provided, skipping auto-registration."
  echo "Register manually: docker exec <container> warp-cli --accept-tos registration new"
fi
